---
title: "Sampling status"
output: html_document
---

```{r setup, include=FALSE}

# Load packages for this page
library(googlesheets4)
library(ggplot2)
library(viridis)
library(knitr)
library(ggmap)
library(tidyverse)

# Load metadata on completed surveys
sheets_deauth()
d = read_sheet("https://docs.google.com/spreadsheets/d/1mNYnSTCs9WYy5SN2HF4VYep550Sccz9xU5o8JuYut-A/edit?usp=sharing",
           sheet='Completed surveys')
d = data.frame(d)


# Load planned site locations
planned = read_sheet("https://docs.google.com/spreadsheets/d/1avm6eedbaLt3V1E3q2lg6IuUs7mPPEKWcsvlhWsfqk4/edit?usp=sharing",
           sheet='planned surveys')
planned = data.frame(planned)

# Load meta data on focal species
dfs = read_sheet("https://docs.google.com/spreadsheets/d/1mNYnSTCs9WYy5SN2HF4VYep550Sccz9xU5o8JuYut-A/edit?usp=sharing",
           sheet='Focal_species')
dfs = data.frame(dfs)

focalFam = function(z) # define function to ID focal families in data frame
	ifelse(z == 'Apocynaceae' | z == 'Asteraceae' | z == 'Fabaceae' | z == 'Solanaceae' |
		z == 'Rubiaceae', TRUE, FALSE)
d$focalFamily = focalFam(d$plantFamily)

d.complete = d[!is.na(d$plantFamily),] # data.frame for complete entries

```

The Herbivory Variability Network has completed `r nrow(d)` surveys on `r length(unique(d.complete$Genus_sp))` plant species from `r length(unique(d.complete$plantFamily))` plant families. These figures and tables update as new data are entered into our database, so check back often! 

We have a three-scaled sampling approach:

1. Sampling one plant species from as many plant families as possible
2. Sampling as many species (and tribes and genera) as possible from five focal families (Apocynaceae, Asteraceae, Fabaceae, Rubiaceae, and Solanaceae)
3. Sampling as many sites as possible for three focal species (_Taraxacum officinale_, _Plantago lanceolata_, and _Plantago major_). 

The goal of this stratified sampling plan is to avoid potential biases in geographic and/or taxonomic coverage, as well as to permit robust exploration of factors that shape patterns in herbivory.

Below we show the current status of our sampling for each of the three scales of sampling, our overall geographic extent, and finally our current plant species list. This information is here to share our progress and help collaborators pick sites and species to survey.

<br>

## Sampling across plant families
```{r echo=FALSE, out.width="800px", fig.align="center", fig.cap="The distribution of currently sampled plant families across the phylogeny of all extant vascular plant families. Our five focal families are in yellow (Apocynaceae, Asteraceae, Fabaceae, Rubiaceae, and Solanaceae), and other sampled families are in purple. Figure made by HerbVar collaborator [Marjorie Weber](http://www.theweberlab.com) with mega-tree from Jin et al. 2019."}

# Load phylogeny packages
require(V.PhyloMaker)
require(taxonlookup)
require(ape)
require(phytools)
require(taxize)

###########################################
# Match genus names to most up to date higher family and order assignments using the Taxonomic Name Resolution Servicet (information here: https://github.com/traitecoevo/taxonlookup) ####
###########################################

# herbvar_genera<-sapply(strsplit(d$Genus_sp, "_"), function(x) x[1])
herbvar_tax_names_clean<-lookup_table(unique(d$Genus_sp),by_species=TRUE,missing_action="NA")
#head(herbvar_tax_names_clean)

# figure out if any queries didn't work.  Can edit them in later in the dataset and re-run to fix, or just omit for now.
omitted<-herbvar_tax_names_clean[is.na(herbvar_tax_names_clean$family),]
#nrow(omitted) #number of entries that there was no name for
#omitted

#genus species, original family, new family
family.naming.table<-data.frame(genus_species=d$Genus_sp[!duplicated(d$Genus_sp)],orig_family=d$plantFamily[!duplicated(d$Genus_sp)],new_family=herbvar_tax_names_clean$family)


#######################################
## make a family level tree figure ####
#######################################
#http://www.scielo.br/scielo.php?script=sci_arttext&pid=S0102-33062017000200191

# load phylogeny of plant families
family_tree <-read.tree("GBOTB.extended.families.tree")
#plot(family_tree,type = 'fan',cex=0.1, main="Mega-Tree of 479 Extant Vascular Plant Families",sub= "(Jin et al. 2019, GBOTB.extended.tre)")

#check that all the family names in herbvar are in the tree 
family.names<-family_tree$tip.label
#tolower(herbvar_tax_names_clean$family)[(!tolower(herbvar_tax_names_clean$family) %in% tolower(family.names))] #missing names

#make a character vector of which families are represented in herbvar (1's) and which aren't (0's)
herbvar.presabs<-rep(0,length(family.names))
herbvar.presabs[tolower(family.names) %in% tolower(herbvar_tax_names_clean$family)]<-1
names(herbvar.presabs)<-family.names
herbvar.presabs[names(herbvar.presabs) == 'Asteraceae'] = 2
herbvar.presabs[names(herbvar.presabs) == 'Apocynaceae'] = 2
herbvar.presabs[names(herbvar.presabs) == 'Fabaceae'] = 2
herbvar.presabs[names(herbvar.presabs) == 'Rubiaceae'] = 2
herbvar.presabs[names(herbvar.presabs) == 'Solanaceae'] = 2

herbvar.colors = rep('transparent', length=length(herbvar.presabs))
herbvar.colors[herbvar.presabs == 1] = 'purple'
herbvar.colors[herbvar.presabs == 2] = '#9B870C'

## plot phylogeny with familys in herbvar in purple

#make edge color vector
# This will be the main vector which colors will be assigned to
col.vector <- vector(mode="character",length=nrow(family_tree$edge))

# Number of tips in the phylogeny
n.tips <- length(family_tree$tip.label)

# Non-terminal branches will be gray
col.vector[family_tree$edge[,2]>n.tips] <- "gray"

# Create a vector of colors 
colors<-c("gray","purple", "yellow")

# create a duplicate of phy$edge which can be manipulated as required
edge.data <- as.data.frame(family_tree$edge)

# Yes, its a loop, but its easier
for(i in 1:length(family_tree$tip.label)){
  spp <- family_tree$tip.label[i]
  spp.trait.val <- as.numeric(herbvar.presabs[grep(spp,names(herbvar.presabs))])
  spp.col <- colors[spp.trait.val+1]
  edge.row <- as.numeric(rownames(edge.data[edge.data$V2==i,]))
  col.vector[edge.row] <- spp.col
}

tips.in_herbvar <-family_tree$tip.label[herbvar.presabs==1]

par(xpd = NA, mar=c(1,1,1,1))
plot(family_tree, show.tip.label=TRUE, edge.col=col.vector, edge.width=2,type = 'fan',cex=0.6,tip.color=herbvar.colors)


```

<br>

## Sampling within plant families

```{r, echo=FALSE, fig.align='center', fig.width=5, fig.asp=1.75, fig.cap="Number of completed surveys per plant family. Our five focal families are in yellow (Apocynaceae, Asteraceae, Fabaceae, Rubiaceae, and Solanaceae)."}

ggplot(d.complete, aes(x=plantFamily, fill=focalFamily)) + geom_bar() + coord_flip() + 
	ylab('No. surveys') + xlab('Plant family') + theme_classic() +
	scale_fill_viridis(discrete=TRUE, alpha=0.8) + theme(legend.position = "none")
```

<br>

## Sampling within focal species

We have three focal species that we are aiming to sampling across the broadest possible geographic extent and across broad environmental gradients. These are _Taraxacum officinale_, _Plantago lanceolata_, and _Plantago major_. This is the newest part of our sampling effort, so we are just starting to collect these data.

```{r, include=FALSE}
map.world = map_data('world')


dfs$Taraxacum.count = as.integer(dfs$Taraxacum.count)
dfs$Plantago_major.count = as.integer(dfs$Plantago_major.count)

map.world$region[map.world$region == 'USA'] = 'United States'
map.world$region[map.world$region == 'UK'] = 'United Kingdom'
map.world$region[map.world$region == 'Russia'] = 'Russian Federation'
map.world$region[map.world$region == 'Democratic Republic of the Congo'] = 'The Democratic Republic of The Congo'
map.world$region[map.world$region == 'Republic of Congo'] = 'Congo'


anti_join(dfs, map.world, by=c('Country' = 'region'))

focal.sp.map.data = left_join(map.world, dfs, by = c('region' = 'Country'))

# For countries not in the list (because of match problems), set count to zero
# Check on this and fix matches as we add countries!
focal.sp.map.data$Taraxacum.count[is.na(focal.sp.map.data$Taraxacum.count)] = 0
focal.sp.map.data$Plantago_major.count[is.na(focal.sp.map.data$Plantago_major.count)] = 0
```


```{r, echo=FALSE, out.width="600px", fig.asp=0.5, fig.align='center'}

# Plot it
ggplot(focal.sp.map.data, aes( x= long, y = lat, group = group)) +
  geom_polygon(aes(fill = Taraxacum.count)) +
  scale_fill_gradient(low='grey90', high=viridis(2)[1], breaks=0:max(focal.sp.map.data$Taraxacum.count)) +
  guides(fill = guide_legend(reverse = T)) +
  labs(fill = 'No. surveys'
       ,title = expression(~italic('Taraxacum officinale')~'surveys by country')
       ,subtitle = NULL
       ,x = NULL
       ,y = NULL) +
  theme_bw() +
	theme(axis.title=element_blank(), axis.text=element_blank(),
		axis.ticks=element_blank()) +
	coord_fixed()
```

```{r, echo=FALSE, out.width="600px", fig.asp=0.5, fig.align='center'}
ggplot(focal.sp.map.data, aes( x= long, y = lat, group = group)) +
  geom_polygon(aes(fill = Plantago_major.count)) +
  scale_fill_gradient(low='grey90', high=viridis(2)[1], breaks=0:max(focal.sp.map.data$Plantago_major.count, na.rm = TRUE)) +
  guides(fill = guide_legend(reverse = T)) +
  labs(fill = 'No. surveys'
       ,title = expression(~italic('Plantago major')~'surveys by country')
       ,subtitle = NULL
       ,x = NULL
       ,y = NULL) +
  theme_bw() +
	theme(axis.title=element_blank(), axis.text=element_blank(),
		axis.ticks=element_blank()) +
	coord_fixed()

```

<br>

## Geographic extent

A map of our sampling progress.

```{r, echo=FALSE, warning=FALSE, out.width = "800px", fig.asp=0.5, fig.align='center', fig.cap="Sampling areas with at least one completed survey. Weâ€™re continually adding new sites."}
mapWorld = borders("world", colour="gray80", fill="gray80") # create a layer of borders
ggplot(data=d, aes(x=longitude.location, y=latitude.location)) + 
	mapWorld + 
	theme_bw() + 
	theme(axis.title=element_blank(), axis.text=element_blank(),
		axis.ticks=element_blank()) + 
  #geom_hex(bins=c(60,80)*1.5) +
	geom_point(fill=viridis(2)[2], size=1.75, shape=21, alpha=0.7) +
	coord_fixed() #+
  #scale_fill_viridis(alpha=1, direction=1)
```

<br>

## Species list

Our current species list with the number of surveys completed for each species.

```{r, echo=FALSE}
Genus_sp.form = paste(d.complete$plantFamily, ":", '*', d.complete$Genus_sp, '*', sep='')
Genus_sp.form = sub('_', ' ', Genus_sp.form)
num.spp = table(Genus_sp.form)
num.spp = data.frame(num.spp)
num.spp = separate(num.spp, 1, into=c("Plant family", "Plant species"), sep=':')
kable(num.spp, col.names=c('Plant family', 'Plant species', 'No. surveys'), align=c('l','l', 'l'))
```

